<?php require_once 'DB.php'; ?>
<!DOCTYPE html>

<head>
   <title>Kyselyn muokkaus</title>
   <meta charset="utf-8">
</head>
<body>

   <?php
       $yhteys = db::getDB();

       // Otsikon uudelleennimeäminen
       $sqlnimi = 'UPDATE Kurssikysely SET kknimi = ? WHERE kurssikyselyID = ?';
       $unimi = $yhteys->prepare($sqlnimi);
       $unimi->execute(array($_POST["kknimi"], $_GET["kyselyid"]));

       // Kyselyn nimi ja tila
       $sqlo = 'SELECT kknimi, esilla FROM Kurssikysely WHERE kurssikyselyID = ?';
       $otsikko = $yhteys->prepare($sqlo);
       $otsikko->execute(array($_GET["kyselyid"]));
       $otsikkov = $otsikko->fetch();

       //Kysymyksen poisto
       $sql = 'DELETE FROM Kysymys WHERE kysymysID = ?';
       $poisto = $yhteys->prepare($sql);
       $poisto->execute(array($_GET["remv"]));

       // Uuden kysymyksen lisääminen tietokantaan
       $ukysymys = $_POST["ukysymys"];
       $sql0 = 'INSERT INTO Kysymys VALUES (?, ?)';
       $lisays = $yhteys->prepare($sql0);
       $lisays->execute(array($ukysymys, $_GET["kyselyid"]));

       // Uuden kyselyn jo olemassa olevien kysymysten haku
       $sql1 = 'SELECT kysymys, kysymysID FROM Kysymys WHERE kurssikyselyID = ?';
       $uusi = $yhteys->prepare($sql1);
       $uusi->execute(array($_GET["kyselyid"]));
       $uudet = $uusi->fetchAll();

       //  Mihin kurssiin kysely liittyy
       $sqlkurssi = 'SELECT nimi, vuosi, periodi FROM Kurssi INNER JOIN Kurssikysely ON Kurssikysely.kurssiID = Kurssi.kurssiID WHERE kurssikyselyID = ?';
       $kurssinimi = $yhteys->prepare($sqlkurssi);
       $kurssinimi->execute(array($_GET["kyselyid"]));
       $kntulos = $kurssinimi->fetch();

       // Kyselyn tilan muokkaaminen
       $sqltila = 'UPDATE Kurssikysely SET esilla = ? WHERE kurssikyselyID = ?';
       $tilaa = $yhteys->prepare($sqltila);
       $tilaa->execute(array($_POST["tila"], $_GET["kyselyid"]));
   ?>

   <!-- Otsikko ja sen muuttaminen -->
   <h2>Kurssin <?php print $kntulos['nimi'];?>, <?php print $kntulos['periodi'];?>/<?php print $kntulos['vuosi'];?></h2>
   <p><b><?php print $otsikkov['kknimi']; ?></b></p>

   <form action="muokkaa.php?opettaja=<?php print $_GET['opettaja'];?>&kyselyid=<?php print $_GET['kyselyid'];?>" method="post">
   <input type="text" name="kknimi">
   <input type="submit" value = "Muuta nimeä">
   </form>  </br></br>


   <!-- Kyselyssä olevat kysymykset ja niiden poistolinkki-->
   <table border="0" cellpadding="3">
        <th align="left">Tallennetut kysymykset</th>
        <tr>
           <?php
                 for ($i = 0, $size = sizeof($uudet); $i < $size; ++$i) {
           ?>

              <td><?php print $uudet[$i]['kysymys'];?></td>
              <td><a href=muokkaa.php?opettaja=<?php print $_GET["opettaja"];?>&&remv=<?php print $uudet[$i]['kysymysid'];?>&&kyselyid=<?php print $_GET["kyselyid"];?>>Poista</a>
        </tr>
           <?php } ?>
       </table>
       </br>

   <!-- Uuden kysymyksen lisääminen -->
   <FORM action="muokkaa.php?opettaja=<?php print $_GET['opettaja'];?>&kyselyid=<?php print $_GET['kyselyid'];?>" method="post">
      <input type="text" name="ukysymys">
      <input type="submit" value="Lisää kysymys">
   </FORM>  </br></br>

   <!-- Kyselyn tila (näkyvyys) -->
   <?php
         if ($otsikkov['esilla']) {
            $tila = "Julkinen";
            $booli = False;
         }
         else {
            $tila = "Piilossa";
            $booli = True;
         }
   ?>
   <p><b>Kyselyn tila: </b><?php print $tila;?></p>
     <FORM action="muokkaa.php?opettaja=<?php print $_GET['opettaja'];?>&kyselyid=<?php print $_GET['kyselyid'];?>" method="post">
        <input type="hidden" name="tila" value="<?php print $booli;?>">
        <input type="submit" value="Muuta">
     </FORM>
   </p>


   <!-- Paluulinkki -->
   <a href=opettaja.php?opettaja=<?php print $_GET["opettaja"];?>>Takaisin</a>

</body>

<?php
// Lisää: tila & muokkaus, poisto
?>


